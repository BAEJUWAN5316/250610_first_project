<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì ë©”ì¶”ë¦¬ - ì±—ë´‡</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-r from-pink-500 to-red-500 flex items-center justify-center">

  <div class="w-full max-w-6xl bg-white rounded-2xl shadow-xl flex overflow-hidden">

    <!-- âœ… ì™¼ìª½: ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ ì±—ë´‡ -->
    <div class="w-1/2 bg-white p-6 flex flex-col items-center justify-start relative">
      <div class="w-80 h-[600px] bg-gray-100 rounded-3xl shadow-inner border-4 border-purple-300 relative overflow-hidden flex flex-col">

        <!-- ìƒë‹¨ë°” + ë²„íŠ¼ -->
        <div class="bg-purple-500 text-white text-lg font-bold px-4 py-3 flex justify-between items-center">
          <span>ì ë©”ì¶”ë¦¬</span>
          <div class="space-x-2 text-sm">
            <button onclick="resetChat()" class="bg-white text-purple-500 px-2 py-1 rounded hover:bg-purple-100">ì´ˆê¸°í™”</button>
            <button onclick="logout()" class="bg-white text-pink-500 px-2 py-1 rounded hover:bg-pink-100">ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>

        <!-- ì±„íŒ…ì°½ -->
        <div id="chat-box" class="flex-1 p-4 overflow-y-auto space-y-2 text-sm text-gray-800" style="white-space: pre-wrap;">
          <!-- ì±„íŒ… ë‚´ìš© ë“¤ì–´ê° -->
        </div>

        <!-- ì…ë ¥ì°½ -->
        <form id="chat-form" class="p-3 bg-white border-t border-gray-200 flex gap-2">
          <input id="question-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required
            class="flex-1 px-3 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-300 text-sm" />
          <button type="submit"
            class="bg-pink-400 hover:bg-pink-500 text-white px-4 py-2 rounded-full text-sm font-semibold">
            ì „ì†¡
          </button>
        </form>
      </div>
    </div>

    <!-- âœ… ì˜¤ë¥¸ìª½: ë¸Œëœë“œ ê³µê°„ -->
    <div class="w-1/2 bg-gradient-to-tr from-purple-900 to-pink-500 text-white flex flex-col items-center justify-center relative p-10">
      <h1 class="text-4xl font-extrabold mb-4">ì ì‹¬ ë©”ë‰´ë¥¼ ì¶”ì²œí•´ë“œë ¤ìš”!</h1>
      <p class="text-lg text-pink-100">ì˜¤ëŠ˜ ë­ ë¨¹ì„ì§€ ì ë©”ì¶”ë¦¬ê°€ ë„ì™€ë“œë¦´ê²Œìš”!</p>

      <!-- ì¥ì‹ ì› -->
      <div class="absolute top-0 right-0 w-full h-full pointer-events-none overflow-hidden">
        <div class="absolute w-32 h-32 bg-pink-300 rounded-full top-10 left-10 animate-bounce"></div>
        <div class="absolute w-20 h-20 bg-pink-200 rounded-full bottom-20 right-20 animate-pulse"></div>
        <div class="absolute w-10 h-10 bg-white opacity-30 rounded-full top-1/2 left-1/3 animate-spin"></div>
      </div>
    </div>

  </div>

  <!-- âœ… ìë°”ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    const form = document.getElementById("chat-form");
    const input = document.getElementById("question-input");
    const chatBox = document.getElementById("chat-box");
    const button = form.querySelector("button");

    // âœ… ì‚¬ìš©ì ì´ë¦„ (Jinja2ë¡œ ì„œë²„ì—ì„œ ì£¼ì…ë¨)
    const username = '{{ username }}';
    const localStorageKey = `chatHistory_${username}`;

    // âœ… ëŒ€í™” ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    window.addEventListener("load", () => {
      const savedChat = localStorage.getItem(localStorageKey);
      if (savedChat) {
        chatBox.innerHTML = savedChat;
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    });

    // âœ… ì§ˆë¬¸ ì „ì†¡
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const question = input.value.trim();
      if (!question) return;

      input.disabled = true;
      button.disabled = true;

      chatBox.innerHTML += `<div class="text-right"><span class="bg-pink-200 px-3 py-2 rounded-full inline-block mb-1">ğŸ‘¤ <strong>ë‚˜:</strong> ${question}</span></div>`;

      const loadingMessage = document.createElement("div");
      loadingMessage.innerHTML = `<span class="bg-purple-100 px-3 py-2 rounded-full inline-block">ğŸ¥ <strong>ì ë©”ì¶”ë¦¬:</strong> <em>ë¡œë”© ì¤‘...</em></span>`;
      chatBox.appendChild(loadingMessage);

      input.value = "";
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const response = await fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question })
        });

        const data = await response.json();
        const answer = data.answer.replace(/\n/g, "<br>");
        loadingMessage.innerHTML = `<span class="bg-purple-100 px-3 py-2 rounded-full inline-block">ğŸ¤ <strong>ì ë©”ì¶”ë¦¬:</strong> ${answer}</span>`;
      } catch (error) {
        loadingMessage.innerHTML = `<span class="bg-red-100 px-3 py-2 rounded-full inline-block">ğŸ¤ <strong>ì ë©”ì¶”ë¦¬:</strong> ì‘ë‹µ ì‹¤íŒ¨</span>`;
      }

      input.disabled = false;
      button.disabled = false;
      input.focus();

      localStorage.setItem(localStorageKey, chatBox.innerHTML);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // âœ… ëŒ€í™” ì´ˆê¸°í™”
    function resetChat() {
      if (confirm("ëŒ€í™”ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
        localStorage.removeItem(localStorageKey);
        chatBox.innerHTML = "";
      }
    }

    // âœ… ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    function logout() {
      document.cookie = "username=; max-age=0; path=/";
      window.location.href = "/";
    }
  </script>
</body>
</html>
